name: Trigger Build Chain

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '**/*.tex'
      - 'THE_ORANGE_PAPER.md'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  trigger-consensus:
    name: Trigger bllvm-consensus Build
    runs-on: [self-hosted, linux, x64]
    steps:
      - name: Determine version/tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Triggering bllvm-consensus build with version: ${VERSION}"
      
      - name: Trigger bllvm-consensus build
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: BTCDecoded/bllvm-consensus
          event-type: build-chain
          client-payload: |
            {
              "triggered_by": "bllvm-spec",
              "version": "${{ steps.version.outputs.version }}",
              "source_ref": "${{ github.ref }}",
              "source_sha": "${{ github.sha }}"
            }

